if("function"!=typeof define)var define=require("amdefine")(module);var __hasProp={}.hasOwnProperty,__extends=function(e,t){for(var r in t)__hasProp.call(t,r)&&(e[r]=t[r]);function i(){this.constructor=e}return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};define(["../disposable","./paging-model","moment"],function(e,t,r){var i,s;return{RecordManager:i=function(e){function i(e,t){this.options=e,this.reportingService=t,i.__super__.constructor.apply(this,arguments)}return __extends(i,e),i.prototype.initialize=function(e){var r,s;return i.__super__.initialize.call(this,e),this.records=new t.PagingModel({predicate:null!=(r=this.options.predicate)?r:"_index",reverse:!1}),this.parameters={},this.recordType={type:null!=(s=this.options.recordType)?s:"hour"},this.recordTypes=[{type:"hour",name:"小时记录"},{type:"day",name:"今日记录"},{type:"week",name:"本周记录"},{type:"month",name:"本月记录"},{type:"year",name:"本年记录"}]},i.prototype.dispose=function(){return i.__super__.dispose.apply(this,arguments),this.records.setItems([]),this.parameters={}},i.prototype.selectRecordType=function(e){return null==e&&(e=this.recordType),this.recordType=e},i.prototype.getPeriod=function(e){var t,i;switch(null==e&&(e=this.recordType),e.type){case"60minutes":i=r().subtract(60,"minutes"),t=r();break;case"hour":i=r().startOf("hour"),t=r().endOf("hour");break;case"day":i=r().startOf("day"),t=r().endOf("day");break;case"week":i=r().startOf("week"),t=r().endOf("week");break;case"month":i=r().startOf("month"),t=r().endOf("month");break;case"year":i=r().startOf("year"),t=r().endOf("year");break;default:i=r().subtract(60,"minutes"),t=r()}return this.period={startTime:i,endTime:t,type:e.type}},i.prototype.nextPeriod=function(){var e,t;if(!this.period)return this.getPeriod();switch(this.period.type){case"60minutes":t=this.period.endTime,e=r(this.period.endTime).add(60,"minutes");break;case"hour":t=r(this.period.startTime).add(1,"hour").startOf("hour"),e=r(this.period.startTime).add(1,"hour").endOf("hour");break;case"day":t=r(this.period.startTime).add(1,"day").startOf("day"),e=r(this.period.startTime).add(1,"day").endOf("day");break;case"week":t=r(this.period.startTime).add(1,"week").startOf("week"),e=r(this.period.startTime).add(1,"week").endOf("week");break;case"month":t=r(this.period.startTime).add(1,"month").startOf("month"),e=r(this.period.startTime).add(1,"month").endOf("month");break;case"year":t=r(this.period.startTime).add(1,"year").startOf("year"),e=r(this.period.startTime).add(1,"year").endOf("year");break;default:t=this.period.endTime,e=r(this.period.endTime).add(60,"minutes")}return this.period={startTime:t,endTime:e,type:this.period.type}},i.prototype.previousPeriod=function(){var e,t;if(!this.period)return this.getPeriod();switch(this.period.type){case"60minutes":t=r(this.period.startTime).subtract(60,"minutes"),e=this.period.startTime;break;case"hour":t=r(this.period.startTime).subtract(1,"hour").startOf("hour"),e=r(this.period.startTime).subtract(1,"hour").endOf("hour");break;case"day":t=r(this.period.startTime).subtract(1,"day").startOf("day"),e=r(this.period.startTime).subtract(1,"day").endOf("day");break;case"week":t=r(this.period.startTime).subtract(1,"week").startOf("week"),e=r(this.period.startTime).subtract(1,"week").endOf("week");break;case"month":t=r(this.period.startTime).subtract(1,"month").startOf("month"),e=r(this.period.startTime).subtract(1,"month").endOf("month");break;case"year":t=r(this.period.startTime).subtract(1,"year").startOf("year"),e=r(this.period.startTime).subtract(1,"year").endOf("year");break;default:t=r(this.period.startTime).subtract(60,"minutes"),e=this.period.startTime}return this.period={startTime:t,endTime:e,type:this.period.type}},i.prototype.queryRecords=function(e,t,i,s){var a,o,n,d,p,h,u;switch(null==i&&(i=1),null==s&&(s=null!=(p=this.options.pageItems)?p:20),t){case"next":n=this.nextPeriod();break;case"previous":n=this.previousPeriod();break;case"refresh":n=null!=(h=this.period)?h:this.getPeriod();break;default:n=this.getPeriod()}return o={page:i,pageItems:s},(d={})[this.records.predicate]=this.records.reverse?-1:1,null==e&&(e={}),e.startTime=n.startTime,e.endTime=n.endTime,this.parameters={filter:e,startTime:n.startTime,endTime:n.endTime,queryTime:r(),periodType:t,paging:o,sorting:d},a={filter:e,fields:null,paging:o,sorting:d},this.queryReport(a,(u=this,function(e,t,r){var i,s,a;return t=u.processRecords(t),u.records.setItems(t),r&&r.pageCount>1&&(r.pages=function(){a=[];for(var e=1,t=r.pageCount;1<=t?e<=t:e>=t;1<=t?e++:e--)a.push(e);return a}.apply(this)),u.parameters.paging=r}))},i.prototype.queryReport=function(e,t){return this.reportingService.queryRecords(this.options.key,e,t)},i.prototype.processRecords=function(e){var t,r,i;if(e){for(r=0,i=e.length;r<i;r++)t=e[r],this.processRecord(t);return e}},i.prototype.processRecord=function(e){return e},i.prototype.queryPage=function(e){var t,r;if((t=null!=(r=this.parameters)?r.paging:void 0)&&("next"===e?e=t.page+1:"previous"===e&&(e=t.page-1),!(e>t.pageCount||e<1)))return this.queryRecords(this.parameters.item,this.parameters.periodType,e,t.pageItems)},i}(e.Disposable)}});