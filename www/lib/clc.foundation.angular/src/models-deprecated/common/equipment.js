if("function"!=typeof define)var define=require("amdefine")(module);var __hasProp={}.hasOwnProperty,__extends=function(t,e){for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);function n(){this.constructor=t}return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};define(["../view-model","./properties","./signals","./events","./commands","underscore","rx"],function(t,e,o,n,i,r,s){var p,u;return{Equipment:p=function(t){function p(t,r){p.__super__.constructor.call(this,t,r),this.station=this.parent.parent,this.project=this.station.project,this.properties=new e.Properties(this),this.signals=new o.Signals(this),this.events=new n.Events(this),this.commands=new i.Commands(this),this.sampleUnits={},this.propertyValues={},this.subject=new s.Subject}return __extends(p,t),p.prototype.getIds=function(){var t;return(t=this.station.getIds()).equipment=this.model.equipment,t},p.prototype.loadEquipmentTemplate=function(t,e,o){var n,i;return!o&&this.templateLoaded?"function"==typeof e?e(null,this.equipmentTemplate):void 0:(n={type:this.model.type,template:this.model.template},this.project.loadEquipmentTemplate(n,t,(i=this,function(t,o){return i.templateLoaded=!0,i.setEquipmentTemplate(o),"function"==typeof e?e(t,i.equipmentTemplate):void 0}),o))},p.prototype.setModel=function(t,e){return!!p.__super__.setModel.call(this,t,e)&&(this.setImage(),this.updatePropertyValues(),!0)},p.prototype.updatePropertyValues=function(){var t,e,o,n,i,r,s,p,u,a;for(o={},i=0,s=(u=this.properties.items).length;i<s;i++)o[(e=u[i]).model.property]=e.getValue();if(this.model.properties)for(r=0,p=(a=this.model.properties).length;r<p;r++)o[(e=a[r]).id]=e.value;for(t in o)n=o[t],this.setPropertyValue(t,n);return this.propertyValues},p.prototype.setImage=function(){var t,e;return this.image=null!=(t=this.model.image)?t:null!=(e=this.equipmentTemplate)?e.getModelValue("image"):void 0},p.prototype.setEquipmentTemplate=function(t){var e,o,n,i,r;if(t&&(this.setImage(),this.sampleUnits=t.getSampleUnits(!0),this.model.sampleUnits))for(n=0,i=(r=this.model.sampleUnits).length;n<i;n++)o=r[n],(e=this.sampleUnits[o.id])&&null!=o.value&&(e.value=o.value);return this.equipmentTemplate=t},p.prototype.getChanges=function(t){var e,o,n,i,s,u,a,l;for(e=p.__super__.getChanges.call(this,t),n=[],u=0,a=(l=this.properties.items).length;u<a;u++)(i=l[u]).isChanged()&&(o={id:i.model.property,value:i.value},n.push(o));return e.properties=n,s=r.map(this.sampleUnits,function(t){var e;return{id:t.id,value:t.value}}),e.sampleUnits=s,e},p.prototype.loadProperties=function(t,e,o){return!o&&this.propertiesLoaded?"function"==typeof e?e(null,this.properties.items):void 0:this.loadEquipmentTemplate(null,(n=this,function(i,r){return n.propertiesLoaded=!0,r?r.loadProperties(t,function(t,o){var i;return o?(i=n.addProperties(o),"function"==typeof e?e(t,i):void 0):"function"==typeof e?e(t):void 0},o):"function"==typeof e?e(i):void 0}),o);var n},p.prototype.addProperties=function(t){var e,o,n,i,r,s,p,u,a,l;if(n=function(){var e,o,n;for(n=[],e=0,o=t.length;e<o;e++)i=t[e],n.push(i.model);return n}(),o=this.properties.addItems(n),t=this.propertyValues)for(s=0,u=o.length;s<u;s++)(e=o[s]).setValue(t[e.model.property]);for(r=this.project.typeModels.units,p=0,a=o.length;p<a;p++)e=o[p],null==t[e.model.property]&&this.setPropertyValue(e.model.property,e.getValue()),e.unit=null!=(l=r.getItem(e.model.unit))?l.model:void 0;return o},p.prototype.getPropertyValue=function(t,e){var o;return null!=(o=this.propertyValues[t])?o:e},p.prototype.setPropertyValue=function(t,e){var o,n;return(n=this.properties.getItemByIds({property:t}))&&(e=n.setValue(e)),e===(o=this.propertyValues[t])?e:(this.propertyValues[t]=e,this.subject.onNext({type:"property",key:t,value:e,oldValue:o}),e)},p.prototype.subscribePropertyValue=function(t,e,o,n){var i,r,s;return o&&(i={type:"property",key:t,value:this.propertyValues[t]},"function"==typeof e&&e(i)),s=(s=this.subject).where(function(e){return"property"===e.type&&e.key===t}),n&&(s=s.throttle(n)),r=s.subscribe(e),this.addHandler(r),r},p.prototype.subscribePropertiesValue=function(t,e,o){var n,i;return i=this.subject,o&&(i=i.throttle(o)),n=i.where(d(function(){return"property"===d.type&&t.indexOf(d.key)>=0})).subscribe(e),this.addHandler(n),n},p.prototype.loadSignals=function(t,e,o){return!o&&this.signalsLoaded?"function"==typeof e?e(null,this.signals.items):void 0:this.loadEquipmentTemplate(null,(n=this,function(i,r){return n.signalsLoaded=!0,r?r.loadSignals(t,function(t,o){var i;return o?(i=n.addSignals(o),"function"==typeof e?e(t,i):void 0):"function"==typeof e?e(t):void 0},o):"function"==typeof e?e(i):void 0}),o);var n},p.prototype.addSignals=function(t){var e,o,n,i,r,s;for(n=function(){var e,o,n;for(n=[],e=0,o=t.length;e<o;e++)i=t[e],n.push(i.model);return n}(),r=0,s=(o=this.signals.addItems(n)).length;r<s;r++)e=o[r],this.station.signals[e.key]=e,this.project.addSignal(e);return o},p.prototype.loadEvents=function(t,e,o){return!o&&this.eventsLoaded?"function"==typeof e?e(null,this.events.items):void 0:this.loadEquipmentTemplate(null,(n=this,function(i,r){return n.eventsLoaded=!0,r?r.loadEvents(t,function(t,o){var i;return o?(i=n.addEvents(o),"function"==typeof e?e(t,i):void 0):"function"==typeof e?e(t):void 0},o):"function"==typeof e?e(i):void 0}),o);var n},p.prototype.addEvents=function(t){var e,o,n,i,r,s;for(i=function(){var o,n,i;for(i=[],o=0,n=t.length;o<n;o++)e=t[o],i.push(e.model);return i}(),r=0,s=(n=this.events.addItems(i)).length;r<s;r++)o=n[r],this.station.events[o.key]=o,this.project.addEvent(o);return n},p.prototype.loadCommands=function(t,e,o){return!o&&this.commandsLoaded?"function"==typeof e?e(null,this.commands.items):void 0:this.loadEquipmentTemplate(null,(n=this,function(i,r){return n.commandsLoaded=!0,r?r.loadCommands(t,function(t,o){var i;return o?(i=n.addCommands(o),"function"==typeof e?e(t,i):void 0):"function"==typeof e?e(t):void 0},o):"function"==typeof e?e(i):void 0}),o);var n},p.prototype.addCommands=function(t){var e,o,n,i,r,s;for(i=function(){var o,n,i;for(i=[],o=0,n=t.length;o<n;o++)e=t[o],i.push(e.model);return i}(),r=0,s=(n=this.commands.addItems(i)).length;r<s;r++)o=n[r],this.station.commands[o.key]=o,this.project.addCommand(o);return n},p.prototype.dispose=function(){return p.__super__.dispose.apply(this,arguments),this.subject.dispose(),this.signals.dispose(),this.events.dispose(),this.commands.dispose()},p.prototype.getTemplateValue2=function(t,e){var o;if(e)return null!=(o=e.model[t])?o:this.getTemplateValue2(t,e.base)},p.prototype.getTemplateValue=function(t){var e;return null!=(e=this.model[t])?e:this.getTemplateValue2(t,this.equipmentTemplate)},p}(t.ViewModel)}});