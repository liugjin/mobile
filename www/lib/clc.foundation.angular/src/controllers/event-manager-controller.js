if("function"!=typeof define)var define=require("amdefine")(module);var __hasProp={}.hasOwnProperty,__extends=function(e,t){for(var r in t)__hasProp.call(t,r)&&(e[r]=t[r]);function n(){this.constructor=e}return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};define(["./live-controller","moment","../models/paging-model"],function(e,t,r){var n,i;return{EventManagerController:n=function(e){function n(e,t,i,s,o,c,u,a,v,p,m,h){n.__super__.constructor.call(this,e,t,i,s,o,c,u,a,v,p,m,h),this.endColor="grey",this.eventSeverities={},this.eventRecords=new r.PagingModel({predicate:"name",reverse:!1}),this.signalRecordsParameters={},this.eventRecordsParameters={},this.loadEventSeverities(),this.eventExpectedDuration=36e5,this.events={},this.startEvents={},this.subscribeEventValues(),this.updateDuration(),this.eventStatistic={},this.eventStatisticSetting={title:"告警统计信息",subTitle:"按告警状态类型统计",severities:this.eventSeverities},this.subscribeEventStatistic()}return __extends(n,e),n.prototype.load=function(e,t){},n.prototype.loadEventSeverities=function(e,t){var r,n,i,s;return r=this.modelManager.getService("eventseverities"),i={user:this.project.user,project:this.project.project},n="severity name color",r.query(i,n,(s=this,function(t,r){var n,i,o;for(i=0,o=r.length;i<o;i++)n=r[i],s.eventSeverities[n.severity]=n;return"function"==typeof e?e(t,r):void 0}),t)},n.prototype.subscribeEventValues=function(){var e,t,r;return e={user:this.project.user,project:this.project.project},null!=(t=this.eventSubscriptions)&&t.dispose(),this.eventSubscriptions=this.eventLiveSession.subscribeValues(e,(r=this,function(e,t){return r.processEvent(t)}))},n.prototype.processEvent=function(e){var t,r,n,i,s;if(e){if(n=(i=e.message).user+"."+i.project+"."+i.station+"."+i.equipment+"."+i.event+"."+i.severity+".."+i.startTime,this.events.hasOwnProperty(n)){for(r in t=this.events[n],i)s=i[r],t[r]=s;t.endTime&&delete this.startEvents[n]}else t=angular.copy(i),this.events[n]=t,this.addItem(t),t.endTime||(this.startEvents[n]=t);return this.decorateEvent(t),"completed"===i.phase&&(t=this.events[n],delete this.events[n],this.removeItem(t),delete this.startEvents[n]),t}},n.prototype.decorateEvent=function(e){var t,r,n,i,s;return e.updateTime=null!=(r=null!=(n=e.endTime)?n:e.confirmTime)?r:e.startTime,e.eventSeverity=this.eventSeverities[e.severity],e.color=null!=(i=null!=(s=e.eventSeverity)?s.color:void 0)?i:this.endColor,t=e.endTime?new Date(e.endTime):new Date,e.duration=t-new Date(e.startTime),e.startTime2=new Date(e.startTime),e},n.prototype.selectEvent=function(e){if(this.event!==e)return this.event=e},n.prototype.confirmEvent=function(e){var t;return t={_id:e._id,user:e.user,project:e.project,station:e.station,equipment:e.equipment,event:e.event,operator:this.$rootScope.user.user,operatorName:this.$rootScope.user.name,confirmTime:new Date,comment:e.comment},this.eventLiveSession.confirmEvent(t)},n.prototype.updateDuration=function(){var e,t;return e=this.$interval((t=this,function(){var e,r,n,i,s;for(r in s=[],i=t.startEvents)(e=i[r]).duration=new Date-e.startTime2,n=(e.duration/t.eventExpectedDuration*100).toFixed(1),s.push(e.progress=n+"%");return s}),1e3),this.addHandle({dispose:function(t){return function(){return t.$interval.cancel(e)}}(this)})},n.prototype.subscribeEventStatistic=function(){var e,t,r;return e={user:this.project.user,project:this.project.project},null!=(t=this.statisticSubscription)&&t.dispose(),this.statisticSubscription=this.statisticLiveSession.subscribeValues(e,(r=this,function(e,t){return r.eventStatistic=null!=t?t.message:void 0}))},n.prototype.confirmAllEvents=function(){var e,t;if(this.comment&&(t=confirm("确认所有活动告警？点击OK继续。")))return e={user:this.project.user,project:this.project.project,operator:this.$rootScope.user.user,operatorName:this.$rootScope.user.name,confirmTime:new Date,comment:this.comment},this.eventLiveSession.confirmAllEvents(e)},n.prototype.forceEndAllEvents=function(){var e,t;if(this.comment&&(t=confirm("手动强制结束所有活动告警？点击OK继续。")))return e={user:this.project.user,project:this.project.project,operator:this.$rootScope.user.user,operatorName:this.$rootScope.user.name,confirmTime:new Date,comment:this.comment},this.eventLiveSession.forceEndAllEvents(e)},n.prototype.forceEndEvent=function(e){var t;if(e.comment)return t={_id:e._id,user:e.user,project:e.project,station:e.station,equipment:e.equipment,event:e.event,operator:this.$rootScope.user.user,operatorName:this.$rootScope.user.name,confirmTime:new Date,comment:e.comment},this.eventLiveSession.forceEndEvent(t)},n.prototype.queryEventRecords=function(e){var r,n,i,s;return n={user:e.user,project:e.project,station:e.station,equipment:e.equipment,event:e.event},r=t(),i=t().subtract(60,"minutes"),n.startTime=i,n.endTime=r,this.eventRecordsParameters={event:e,startTime:i,endTime:r,queryTime:new Date},this.reportingService.queryEventRecords(n,null,null,(s=this,function(t,r){var n,i;if(r)for(n=0,i=r.length;n<i;n++)e=r[n],s.decorateEvent(e);return s.eventRecords.setItems(r)}))},n}(e.LiveController)}});