if("function"!=typeof define)var define=require("amdefine")(module);var __hasProp={}.hasOwnProperty,__extends=function(t,e){for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);function n(){this.constructor=t}return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},__indexOf=[].indexOf||function(t){for(var e=0,o=this.length;e<o;e++)if(e in this&&this[e]===t)return e;return-1};define(["../disposable","rx"],function(t,e){var o,n;return{Controller:o=function(t){function o(t,e,n,i,r){this.$scope=t,this.$rootScope=e,this.$routeParams=n,this.$location=i,this.$window=r,o.__super__.constructor.apply(this,arguments)}return __extends(o,t),o.prototype.initialize=function(t){var e,n;return o.__super__.initialize.call(this,t),window.controller=this,window.$controller=this,this.setting=window.setting,this.$rootScope.title=(null!=(e=this.options)?e.title:void 0)||"",this.search=this.$routeParams.search,this.initializeNotification(),this.initializeEventBus(),this.$scope.$on("$destroy",(n=this,function(){return n.dispose()})),this.$window.onbeforeunload=function(t){return function(e){return t.dispose()}}(this)},o.prototype.dispose=function(){return o.__super__.dispose.apply(this,arguments),this.notifySubject.dispose(),this.eventBus.dispose()},o.prototype.initializeEventBus=function(){return this.patterns={},this.eventBus=new e.Subject},o.prototype.publishEventBus=function(t,e){return this.eventBus.onNext({topic:t,message:e})},o.prototype.subscribeEventBus=function(t,e,o){var n,i;return n=this.eventBus.where((i=this,function(e){return i.matchTopic(t,e.topic)})),o&&(n=n.throttle(o)),n.subscribe(e)},o.prototype.matchTopic=function(t,e){var o,n;return(n=this.patterns[t])||(o=t.replace(/\+/g,"[^/]+").replace(/#$/,".+")+"$",n=new RegExp(o),this.patterns[t]=n),n.test(e)},o.prototype.initializeNotification=function(){var t,o;return this.audios={},this.notifySubject=new e.Subject,t=this.notifySubject.where(function(t){return"text"===t.type}).throttle(1e3).subscribe((o=this,function(t){return o.showDesktopNotification(t.title,t.options)})),this.addHandle(t),t=this.notifySubject.where(function(t){return"audio"===t.type}).throttle(1e3).subscribe(function(t){return function(e){return t.playAudio(e.audio,e.options)}}(this)),this.addHandle(t)},o.prototype.display=function(t,e,o){var n,i,r,s;if((null!=t&&"function"==typeof t.indexOf?t.indexOf("[license-error]"):void 0)>=0)this.redirect("/model/license");else if((i=this.formatErrorInfo(t,e))&&(s=this.setting.toastThrottle||500,r=new Date,!this.lastMessage||!(this.lastMessage=i&&r-this.lastMessage.timestamp<s)))return this.lastMessage={message:i,timestamp:r},n=this.setting.toastTime||o||5e3,M.toast({html:i,displayLength:n})},o.prototype.formatErrorInfo=function(t,e){var o;return(o=t?"object"==typeof t?JSON.stringify(t):t:e)&&console.log((new Date).toISOString()+" "+o),o},o.prototype.getBaseUrl=function(){var t,e,o;return(t=(o=this.$location.absUrl()).indexOf("/#/"))<0?o:o.substr(0,t)},o.prototype.encodeUrl=function(t){return btoa(t)},o.prototype.redirect=function(t){return this.$window.location.href=t},o.prototype.open=function(t,e){return window.open(t,e)},o.prototype.goto=function(t,e){if(this.$location.url(t),e)return this.applyChange()},o.prototype.gotoLastPath=function(){var t;if(t=this.$rootScope.lastPath)return this.goto(t)},o.prototype.goBack=function(){return this.$window.history.back()},o.prototype.goForward=function(){return this.$window.history.forward()},o.prototype.fullscreen=function(t){var e,o;if(t&&("string"!=typeof t||(t=(e=angular.element(t))[0])))if(o=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement){if(document.exitFullscreen)return document.exitFullscreen();if(document.webkitExitFullscreen)return document.webkitExitFullscreen(Element.ALLOW_KEYBOARD_INPUT);if(document.mozExitFullScreen)return document.mozExitFullScreen();if(document.msExitFullscreen)return document.msExitFullscreen()}else{if(t.requestFullscreen)return t.requestFullscreen();if(t.webkitRequestFullscreen)return t.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);if(t.mozRequestFullScreen)return t.mozRequestFullScreen();if(t.msRequestFullscreen)return t.msRequestFullscreen()}},o.prototype.applyChange=function(){if(!this.$scope.$$phase)return this.$scope.$apply()},o.prototype.confirm=function(t,e,o,n,i){var r;return $("#prompt-modal").length>0?this.prompt(t,e,o,n,i):(console.log((new Date).toISOString()+" please add directive prompt-modal(options='vm.promptModal') into view for better confirm dialog"),r=confirm(t+" "+e),"function"==typeof o?o(r):void 0)},o.prototype.prompt=function(t,e,o,n,i){var r;r={title:t,message:e,enableComment:n,comment:i,confirm:function(t){return"function"==typeof o?o(t,this.comment):void 0}},this.$scope.$broadcast("openPromptModal",r)},o.prototype.downloadJsonFile=function(t,e){var o,n,i;null==e&&(e="download.json"),t?("object"==typeof t&&(t=JSON.stringify(t,void 0,2)),n=new Blob([t],{type:"text/json"}),i=document.createEvent("MouseEvents"),(o=document.createElement("a")).download=e,o.href=window.URL.createObjectURL(n),o.dataset.downloadurl=["text/json",o.download,o.href].join(":"),i.initEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(i)):console.error("No data")},o.prototype.downloadBlobFile=function(t,e){var o,n;n=document.createEvent("MouseEvents"),(o=document.createElement("a")).download=e,o.href=window.URL.createObjectURL(t),o.dataset.downloadurl=[o.download,o.href].join(":"),n.initEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(n)},o.prototype.notify=function(t,e){return this.notifySubject.onNext({title:t,options:e,type:"text"})},o.prototype.notifyAudio=function(t,e){return this.notifySubject.onNext({audio:t,options:e,type:"audio"})},o.prototype.showDesktopNotification=function(t,e){var o,n;return o=function(){var o,n;if(o=new Notification(t,e),e.onclick&&(o.onclick=(n=this,function(t){return e.onclick(t),o.close()})),e.delay)return setTimeout(function(){return o.close()},e.delay)},window.Notification?"granted"===Notification.permission?o():"denied"!==Notification.permission?Notification.requestPermission((n=this,function(t){if("granted"===t)return o()})):void 0:M.toast({html:message,displayLength:delay})},o.prototype.closeModal=function(t){$(null!=t?t:".modal").modal("close")},o.prototype.openModal=function(t){$(null!=t?t:".modal").modal("open")},o.prototype.parseJson=function(t){var e;return"string"!=typeof t||"{"!==(e=t[0])&&"["!==e?t:JSON.parse(t)},o.prototype.playAudio=function(t){var e,o,n,i;if(t)return(e=this.audios[t])||(e=new Audio(t),this.audios[t]=e),o=null!=(i=e.play())?i.then(function(){return{}}).catch(function(t){var e;return console.error(null!=(e=t.message)?e:t)}):void 0,{dispose:function(){return e.pause()}}},o.prototype.normalizeKey=function(t,e){var o;if(null==e&&(e=this.current),e)return(o=e[t])&&(e[t]=o=o.replace(/[^\w\d_-]+/g,"_"),e.name||(e.name=o.charAt(0).toUpperCase()+o.substr(1))),o},o.prototype.getRootModule=function(t){var e,o,n,i;if(null==t&&(t="clc."),!(i=angular.element(document.body).injector().modules))return null;for(e in o=t.length,i)if(n=i[e],e.substring(0,o)===t)return n;return null},o.prototype.accessModule=function(t){var e,o,n,i,r;return!t||!!(i=this.$rootScope.user)&&(!!(o=this.$rootScope.project)&&("admin"===(r=i.user)||r===o.user||!!(n=this.$rootScope.role)&&("_all"===(e=n.modules)[0]||__indexOf.call(e,t)>=0)))},o.prototype.downloadFileAsync=function(t,e){var o;return(o=new XMLHttpRequest).open("GET",t),o.responseType="blob",o.onload=function(){var t;return t=200===this.status?null:this.status,e(t,o.response)},o.send()},o.prototype.findJsonValuesByKey=function(t,e){var o,n,i,r,s,u,l,c,a;if(s={},!t)return s;if(t instanceof Array)for(c=0,a=t.length;c<a;c++)for(n in o=t[c],r=this.findJsonValuesByKey(o,e))s[u=r[n]]=u;else if("object"==typeof t)for(n in t)if(u=t[n],e instanceof Array&&__indexOf.call(e,n)>=0||n===e){if("string"==typeof u)s[u]=u;else if("object"==typeof u)for(i in r=this.findJsonValuesByKey(u,e))s[l=r[i]]=l}else for(i in r=this.findJsonValuesByKey(u,e))s[l=r[i]]=l;return s},o.prototype.findJsonValuesByProperty=function(t,e,o,n){var i,r,s,u,l,c,a,p,f,d;if(null==o&&(o="property"),null==n&&(n="value"),l={},!t)return l;if(t instanceof Array)for(f=0,d=t.length;f<d;f++)for(r in i=t[f],u=this.findJsonValuesByProperty(i,e,o,n))l[c=u[r]]=c;else if("object"==typeof t)for(r in t)if(c=t[r],r===o&&(e instanceof Array&&__indexOf.call(e,c)>=0||c===e)){if("string"==typeof(p=t[n]))l[p]=p;else if("object"==typeof p)for(s in u=this.findJsonValuesByProperty(p,e,o,n))l[a=u[s]]=a}else for(s in u=this.findJsonValuesByProperty(c,e,o,n))l[a=u[s]]=a;return l},o.prototype.addLocationSearch=function(t){var e,o,n,i;if(t){for(e in o=null!=(i=this.$location.search())?i:{},t)n=t[e],o[e]=n;return this.$location.search(o).replace()}},o.prototype.onSearchChange=function(t){return null==t&&(t=this.search),this.addLocationSearch({search:t})},o.prototype.clearSearch=function(){return this.search=null,this.addLocationSearch({search:null})},o}(t.Disposable)}});