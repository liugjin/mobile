if("function"!=typeof define)var define=require("amdefine")(module);var __hasProp={}.hasOwnProperty,__extends=function(t,e){for(var s in e)__hasProp.call(e,s)&&(t[s]=e[s]);function i(){this.constructor=t}return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};define(["./service","rx"],function(t,e){var s,i;return{LiveService:s=function(t){function s(t,i){var r;this.socket=i,s.__super__.constructor.call(this,t),this.model={},this.subject=new e.Subject,this.subscriptions={},this.maxCachesPerSubscription=100,this.socket.on("message",(r=this,function(t){return r.subject.onNext(t)}))}return __extends(s,t),s.prototype.subscribe=function(t,e,s){var i,r,n,o,u,c,p,a;if(o=this.subscriptions[t]){for(o.count++,o.callbacks.push(e),u=0,c=(p=o.caches).length;u<c;u++)i=p[u],e(i);return o}return n=this.maxCachesPerSubscription,o={topic:t,callback:e,count:1,callbacks:[e],caches:[],publish:function(t){var e,s,i,r,o,u;for((e=this.caches).push(t),e.length>n&&e.splice(0,1),u=[],i=0,r=(o=this.callbacks).length;i<r;i++)s=o[i],u.push(s(t));return u}},r=this.subject.where(function(e){return e.topic===t}).subscribe(function(t){if(o.publish(t),s)return o.dispose()}),o.dispose=(a=this,function(){return--o.count<=0?(r.dispose(),a.socket.emit("unsubscribe",t),delete a.subscriptions[t]):o.callbacks.splice(o.callbacks.indexOf(e),1)}),this.subscriptions[t]=o,this.socket.emit("subscribe",t),o},s.prototype.unsubscribe=function(t,e){var s;return(s=this.subscriptions[t])&&s.dispose(e),s},s.prototype.unsubscribeAll=function(){var t,e,s;for(e in s=this.subscriptions)(t=s[e]).dispose();return this.subscriptions={}},s.prototype.publish=function(t,e){return this.socket.emit("publish",{topic:t,message:e})},s.prototype.login=function(t){return this.socket.emit("login",t)},s.prototype.logout=function(t){return this.socket.emit("logout",t)},s.prototype.executeCommand=function(t,e,s){var i,r,n,o,u,c,p,a,l,h;for(i in n=[],c=e.parameters)u=c[i],n.push({key:i,value:u});return r={user:t.user.user,project:t.project.project,station:t.station.station,equipment:t.equipment.equipment,command:t.command,priority:t.priority,phase:"executing",parameters:n,startTime:new Date,endTime:null,result:null,trigger:"user",operator:null!=(p=null!=(a=e.user)?a.user:void 0)?p:"admin",operatorName:null!=(l=null!=(h=e.user)?h.name:void 0)?l:"admin",comment:e.comment},o="commands/"+t.key,this.subscribe(o,s,!0),this.publish("execute-command",r)},s}(t.Service)}});