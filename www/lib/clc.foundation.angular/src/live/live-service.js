if("function"!=typeof define)var define=require("amdefine")(module);var __hasProp={}.hasOwnProperty,__extends=function(t,e){for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);function r(){this.constructor=t}return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};define(["../services/service","rx","./topic-parser","js-shortid"],function(t,e,o,r){var n,i,s,c,u,p;return u=0,c=0,n=0,i=-1,{LiveService:s=function(t){function n(t,r){this.$rootScope=t,this.socket=r,n.__super__.constructor.apply(this,arguments),this.topicParsers=new o.TopicParser,this.subject=new e.Subject,this.initializeRpc(),this.initializeSocket(this.socket)}return __extends(n,t),n.prototype.initializeSocket=function(t){var e;return t.on("auth",(e=this,function(t){return e.onAuth(t)})),t.on("project",function(t){return function(e){return t.onProject(e)}}(this)),t.on("message",function(t){return function(e){return t.subject.onNext(e)}}(this)),t.on("rpc",function(t){return function(e){return t.rpcSubject.onNext(e)}}(this)),t.on("connect",function(t){return function(){return console.log((new Date).toISOString()+" socket.io connect success"),t.state=0,t.$rootScope.connection=0,t.$rootScope.connectionTimestamp=new Date,t.authenticate()}}(this)),t.on("reconnecting",function(t){return function(e){return console.log((new Date).toISOString()+" reconnecting: "+e),t.$rootScope.connection=e}}(this)),t.on("disconnect",function(t){return function(){return console.log((new Date).toISOString()+" disconnect"),t.state=-1,t.$rootScope.connection=-1,t.$rootScope.connectionTimestamp=new Date,t.disposeAuth()}}(this))},n.prototype.authenticate=function(){return this.$rootScope.$watch("user",(t=this,function(){var e,o,r;if((o=t.$rootScope.user)&&(null!=(r=t.lastUser)?r.user:void 0)!==o.user)return t.lastUser={user:o.user},e={user:o.user,token:o.token},t.emit("auth",e)}));var t},n.prototype.authProject=function(){return this.$rootScope.$watch("project",(t=this,function(){var e,o,r,n,i;if((o=t.$rootScope.project)&&((null!=o?o.model:void 0)&&(o=o.model),!t.lastProject||t.lastProject.user!==o.user||t.lastProject.project!==o.project))return t.lastProject={user:o.user,project:o.project},e={user:o.user,project:o.project,token:null!=(r=null!=(n=t.token)?n.token:void 0)?r:null!=(i=t.$rootScope.user)?i.token:void 0},t.emit("project",e)}));var t},n.prototype.dispose=function(){return n.__super__.dispose.apply(this,arguments),this.subject.dispose(),this.rpcSubject.dispose(),this.disposeAuth()},n.prototype.disposeAuth=function(){return this.lastUser=null,this.lastProject=null,this.token=null,this.role=null},n.prototype.onAuth=function(t){return this.token=t,t.err?this.display(t.err):(console.log((new Date).toISOString()+" live token: "+t.user+"/"+t.token),this.authProject())},n.prototype.onProject=function(t){var e,o,r,n,i,s,c,u,p;return this.role=t.role,this.role&&this.resumeSubscriptions(),t.err?this.display(t.err):((r=this.role.user)||(r=null!=(n=null!=(i=this.$rootScope.project)&&null!=(s=i.model)?s.user:void 0)?n:this.$rootScope.myproject.user),(e=this.role.project)||(e=null!=(c=null!=(u=this.$rootScope.project)&&null!=(p=u.model)?p.project:void 0)?c:this.$rootScope.myproject.project),!(o=this.role.role)&&this.role.isAdmin&&(o="admin"),console.log((new Date).toISOString()+" live role: "+this.$rootScope.user.user+"@"+r+"/"+e+"/"+o))},n.prototype.resumeSubscriptions=function(){var t,e,o,r,n,i;for(r in e=[],i=this.handlers)t={id:(n=(o=i[r]).target).id,topic:n.topic,history:n.history,options:n.options},e.push(t);if(e.length)return this.emit("subscribe",e)},n.prototype.subscribe=function(t,e,o,r){var n,i,s,c;return null==o&&(o=!0),n={id:++u,topic:t,history:o,options:r},i=this.subject.where((c=this,function(t){return t.id===n.id})).subscribe(function(t){return function(t){return"function"==typeof e?e(t.err,t):void 0}}(this)),this.role&&this.emit("subscribe",n),s={id:n.id,topic:n.topic,history:n.history,options:n.options,callback:e,dispose:function(t){return function(){return i.dispose(),t.emit("unsubscribe",n)}}(this)},this.addHandle(s)},n.prototype.publish=function(t,e,o){var r;if(this.role)return r={id:++c,topic:t,message:e,timestamp:new Date,options:o},this.emit("publish",r),r},n.prototype.emit=function(t,e){if(0===this.state)return this.socket.emit(t,e)},n.prototype.initializeRpc=function(){return this.rpcs={},this.rpcSubject=new e.Subject,this.rpcSubject.subscribe((t=this,function(e){var o;return null!=(o=t.rpcs[e.key])?o.onResponse(e):void 0}));var t},n.prototype.rpc=function(t,e){var o,n,i,s,c,u;return null==t.key&&(t.key=r.gen()),o=t.key,c=new Date,n={key:o,timestamp:c,service:t.service,method:t.method,parameters:t.parameters},i={request:n,callback:e},this.rpcs[o]=i,t.timeout>0&&(s=this.setTimeout((u=this,function(){return"function"==typeof i.callback&&i.callback("timeout"),delete u.rpcs[o]}),t.timeout)),i.onResponse=function(t){return function(e){if((null!=e?e.key:void 0)===o)return s&&(s.dispose(),s=null),delete t.rpcs[o],i.response=e,"function"==typeof i.callback&&i.callback(e.err,e.data,e),i.callback=null}}(this),this.emit("rpc",n),i},n}(t.Service)}});